/**
 * WordPress dependencies
 */
import apiFetch from '@wordpress/api-fetch';
import { Button, Notice, Flex } from '@wordpress/components';
import { Icon, cancelCircleFilled } from '@wordpress/icons';
import { RawHTML, useCallback, useContext, useEffect, useState } from '@wordpress/element';

/**
 * Internal dependencies
 */
import SetupProgressBar  from './setup-progress-bar';
import ScreenLink        from './screen-link'
import AutoTabbingInput  from './auto-tabbing-input';
import { refreshRecord } from '../utilities';
import { GlobalContext } from '../script';

export default function TOTP() {
	const { userRecord }     = useContext( GlobalContext );
	const availableProviders = userRecord.record[ '2fa_available_providers' ];
	const totpStatus         = availableProviders.includes( 'Two_Factor_Totp' ) ? 'enabled' : 'disabled';
	const [ isNextClick, setIsNextClick ] = useState( false );

	if ( 'enabled' === totpStatus ) {
		return <Manage />;
	}
	
	if ( ! isNextClick ) {
		return <Intro setIsNextClick={ setIsNextClick } />;
	}

	return <Setup setIsNextClick={ setIsNextClick } />;
}

function Intro( { setIsNextClick }) {
	const handleClick = useCallback( () => setIsNextClick( true ), [] );

	return (
		<>
			<SetupProgressBar step="totp-intro" />
			<Flex expanded={false} direction='column' align="top" justify="top" gap="16px" className="wporg-2fa__totp_intro-container">
				<strong>
					Verify Codes
				</strong>

				<p>
					Two-Factor Authentication adds an extra layer of security to your account.
					Once enabled, logging in to WordPress.org will require you to enter a unique passcode
					generated by an app on your mobile device, in addition to your username and password.
				</p>

				<p>
					To use this, you need to download an app such as
					<a href="https://authy.com/"> Authy </a> 
					or 
					<a href='https://googleauthenticator.net/'> Google Authenticator </a>
					for your phone.
				</p>

				<Button variant="link" onClick={ handleClick }>Next</Button>
			</Flex>
		</>
	);
}

/**
 * Setup the TOTP provider.
 */
function Setup( { setIsNextClick } ) {
	const { clickScreenLink, setGlobalNotice, userRecord } = useContext( GlobalContext );
	const [ secretKey, setSecretKey ]     = useState( '' );
	const [ qrCodeUrl, setQrCodeUrl ]     = useState( '' );
	const [ error, setError ]             = useState( '' );
	const [ setupMethod, setSetupMethod ] = useState( 'qr-code' );
	const [ inputs, setInputs ]			  = useState( Array( 6 ).fill( '' ) );

	// Fetch the data needed to setup TOTP.
	useEffect( () => {
		// useEffect callbacks can't be async directly, because that'd return the promise as a "cleanup" function.
		const fetchSetupData = async () => {
			const response = await apiFetch( {
				path: '/wporg-two-factor/1.0/totp-setup?user_id=' + userRecord.record.id,
			} );

			setSecretKey( response[ 'secret_key' ] );
			setQrCodeUrl( response[ 'qr_code_url' ] );
		};

		fetchSetupData();
	}, [] );

	// Enable TOTP when button clicked.
	const handleEnable = useCallback( async ( event ) => {
		event.preventDefault();
		
		const code = inputs.join( '' );

		try {
			await apiFetch( {
				path: '/two-factor/1.0/totp/',
				method: 'POST',
				data: {
					user_id: userRecord.record.id,
					key: secretKey,
					code,
					enable_provider: true,
				},
			} );

			refreshRecord( userRecord );
			clickScreenLink( event, 'backup-codes' );
			setGlobalNotice( 'Successfully enabled One Time Passwords.' ); // Must be After `clickScreenEvent` clears it.

		} catch( error ) {
			setError( error.message );
		}
	} );

	const handleClick = useCallback( () => setIsNextClick( false ), [] );

	return (
		<>
			<SetupProgressBar step="totp-setup" />

			<Flex expanded={false} direction='column' align="top" justify="top" gap="16px" className="wporg-2fa__totp_setup-container">
				<strong>
					Scan QR Code
				</strong>

				<SetupMethod
					setupMethod={ setupMethod }
					setSetupMethod={ setSetupMethod }
					qrCodeUrl={ qrCodeUrl }
					secretKey={ secretKey }
				/>

				<strong>Enter the six digit code provided by the app</strong>

				<SetupForm
					handleEnable={ handleEnable }
					qrCodeUrl={ qrCodeUrl }
					secretKey={ secretKey }
					inputs={inputs}
					setInputs={setInputs}
				/>

				<Button variant="link" onClick={ handleClick }>Previous</Button>

				{ error &&
					<Notice status="error" isDismissible={ false }>
						<Icon icon={ cancelCircleFilled } />
						{ error }
					</Notice>
				}
			</Flex>
		</>
	);
}

/**
 * Render both methods for setting up TOTP in an app.
 */
function SetupMethod( { setupMethod, setSetupMethod, qrCodeUrl, secretKey } ) {
	if ( 'qr-code' === setupMethod ) {
		const handleClick = useCallback( () => setSetupMethod( 'manual' ), [] );

		return (
			<>
				<p>
					Scan this QR code with the authenticator app.&nbsp;

					<Button variant="link" onClick={ handleClick }>
						Can't scan the QR code?
					</Button>
				</p>

				<div className="wporg-2fa__qr-code">
					{ ! qrCodeUrl && 'Loading...' }

					{ qrCodeUrl &&
						<a href={ qrCodeUrl } aria-label="Scan QR code">
							<RawHTML>
								{ createQrCode( qrCodeUrl ) }
							</RawHTML>
						</a>
					}
				</div>
			</>
		);
	}

	if ( 'manual' === setupMethod ) {
		const readableSecretKey = secretKey.match( /.{1,4}/g ).join( ' ' );

		return (
			<>
				<p>
					Enter this time code into your mobile app.<br />

					<Button isLink onClick={ () => setSetupMethod( 'qr-code' ) }>
						Prefer to scan a QR code?
					</Button>
				</p>

				<code className="wporg-2fa__manual-code">
					{ readableSecretKey }
				</code>
			</>
		);
	}
}

/*
 * Generate a QR code SVG.
 *
 * @param {string} data The data to encode in the QR code.
 */
function createQrCode( data ) {
	const { qrcode } = window; // Loaded via block.json.

	/*
	 * 0 = Automatically select the version, to avoid going over the limit of URL
	 *     length.
	 * L = Least amount of error correction, because it's not needed when scanning
	 *     on a monitor, and it lowers the image size.
	 */
	const qr = qrcode( 0, 'L' );
	qr.addData( data );
	qr.make();

	return qr.createSvgTag( 5 );
}

/**
 * Render the form for entering the TOTP code.
 */
function SetupForm( { handleEnable, qrCodeUrl, secretKey, inputs, setInputs } ) {
	const [ isInputComplete, setIsInputComplete ] = useState(false);

	const handleComplete = useCallback( ( isComplete ) => setIsInputComplete( isComplete ), [])

	const canSubmit = qrCodeUrl && secretKey && isInputComplete;

	return (
		<form className="wporg-2fa__setup-form" onSubmit={ handleEnable }>
			<AutoTabbingInput inputs={inputs} setInputs={setInputs} onComplete={handleComplete}/>

			<div className="wporg-2fa__submit-btn-wrapper">
				<ScreenLink screen="account-status" anchorText="Cancel" buttonStyle="secondary" />

				<Button type="submit" disabled={ ! canSubmit }>
					Enable
				</Button>
			</div>
		</form>
	);
}

/**
 * Disable the TOTP provider.
 */
function Manage() {
	const { userRecord, setGlobalNotice } = useContext( GlobalContext );
	const [ error, setError ]             = useState( '' );

	// Enable TOTP when button clicked.
	const handleDisable = useCallback( async ( event ) => {
		event.preventDefault();

		try {
			await apiFetch( {
				path: '/two-factor/1.0/totp/',
				method: 'DELETE',
				data: { user_id: userRecord.record.id },
			} );

			refreshRecord( userRecord );
			setGlobalNotice( 'Successfully disabled One Time Passwords.' );

		} catch( error ) {
			setError( error.message );
		}
	} );

	return (
		<>
			<p>
				You've enabled two-factor authentication on your account â€” smart move!
				When you log in to WordPress.org, you'll need to enter your username and password, and then enter a unique passcode generated by an app on your mobile device.
			</p>

			<p>
				Make sure you've created { ' ' }
				<ScreenLink screen="backup-codes" anchorText="backup codes" /> { ' ' }
				and saved them in a safe location, in case you ever lose your device. You may also need them when transitioning to a new device.
				Without them you may permanently lose access to your account.
			</p>

			<p>
				<strong>Status:</strong> { ' ' }
				Two-factor authentication is currently <span className="wporg-2fa__enabled-status">on</span>.
			</p>

			<Button isPrimary onClick={ handleDisable }>
				Disable Two-Factor Authentication
			</Button>

			{ error &&
				<Notice status="error" isDismissible={ false }>
					<Icon icon={ cancelCircleFilled } />
					{ error }
				</Notice>
			}
		</>
	);
}
